# APIドキュメント

このドキュメントは、勤務表WebアプリケーションのバックエンドAPIの仕様を定義します。

## ベースURL

`/api`

---

## 1. マスターデータ関連

### 1.1. 在籍中の全社員リストを取得

- **エンドポイント**: `GET /employees`
- **説明**: 作業報告書の氏名選択プルダウンなどで使用する、在籍中（退職フラグが0）の社員リストを取得します。セキュリティのため、パスワード情報は含まれません。
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**:
    ```json
    [
      {
        "employee_id": 1,
        "company_id": 101,
        "employee_name": "山田 太郎",
        "department_name": "開発部",
        "employee_type": "正社員",
        "retirement_flag": 0
      },
      ...
    ]
    ```
- **エラーレスポンス**:
  - **コード**: `500 Internal Server Error`
  - **内容**: `{"error": "サーバー内部エラー"}`

### 1.2. 全社員リストを取得（マスターメンテナンス用）

- **エンドポイント**: `GET /employees/all`
- **説明**: マスターメンテナンス画面で使用する、全社員（退職者も含む）のリストを取得します。
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**: (1.1と同様の社員オブジェクトの配列)
- **エラーレスポンス**:
  - **コード**: `500 Internal Server Error`
  - **内容**: `{"error": "サーバー内部エラー"}`

### 1.3. 会社マスターを取得

- **エンドポイント**: `GET /companies`
- **説明**: 全ての会社情報を取得します。
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**:
    ```json
    [
      {
        "company_id": 101,
        "company_name": "株式会社ABC"
      },
      ...
    ]
    ```

### 1.4. 指定年の祝日リストを取得

- **エンドポイント**: `GET /holidays/<year>`
- **説明**: 指定された年の祝日リストを、「日付: 祝日名」の形式で取得します。
- **URLパラメータ**:
  - `year` (integer): 祝日を取得したい西暦年。
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**:
    ```json
    {
      "2025-01-01": "元日",
      "2025-10-13": "スポーツの日",
      ...
    }
    ```

---

## 2. 作業報告書関連

### 2.1. 指定年月の作業記録を取得

- **エンドポイント**: `GET /work_records/<employee_id>/<year>/<month>`
- **説明**: 指定した社員の特定年月の作業記録（日次）と特記事項（月次）を取得します。
- **URLパラメータ**:
  - `employee_id` (integer)
  - `year` (integer)
  - `month` (integer)
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**:
    ```json
    {
      "records": [
        {
          "day": 1,
          "start_time": "09:00",
          "end_time": "18:00",
          "break_time": "01:00",
          "work_content": "要件定義"
        },
        ...
      ],
      "special_notes": "月次報告です。"
    }
    ```

### 2.2. 作業記録を保存

- **エンドポイント**: `POST /work_records`
- **説明**: 作業報告書の日次記録と特記事項を一括で保存（更新または新規作成）します。この操作は、操作対象の`employee_id`がオーナーIDと一致する場合にのみ許可されます。
- **リクエストボディ**:
  ```json
  {
    "employee_id": 1,
    "year": 2025,
    "month": 10,
    "records": [
      { "day": 1, "start_time": "09:00", ... },
      ...
    ],
    "special_notes": "更新された特記事項。"
  }
  ```
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**: `{"message": "保存しました"}`
- **エラーレスポンス**:
  - `400 Bad Request`: `{"error": "無効なデータです"}`
  - `403 Forbidden`: `{"error": "作業記録を更新する権限がありません。"}`
  - `500 Internal Server Error`: `{"error": "データベースエラー"}`

---

## 3. 日報関連

### 3.1. 指定日の日報データを取得

- **エンドポイント**: `GET /daily_report/<employee_id>/<date_str>`
- **説明**: 指定した社員の特定の日付の日報データを取得します。
- **URLパラメータ**:
  - `employee_id` (integer)
  - `date_str` (string, `YYYY-MM-DD`形式)
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**: (データが存在する場合)
    ```json
    {
      "report_id": 1,
      "employee_id": 1,
      "date": "2025-10-01",
      "work_summary": "詳細な作業内容",
      "problems": "発生した問題点",
      "challenges": "今後の課題",
      "tomorrow_tasks": "明日行うタスク",
      "thoughts": "所感"
    }
    ```
  - **内容**: (データが存在しない場合) `null`

### 3.2. 日報データを保存

- **エンドポイント**: `POST /daily_report`
- **説明**: 日報データを保存（更新または新規作成）します。関連する`work_records`テーブルの作業内容も同時に更新されます。
- **リクエストボディ**:
  ```json
  {
    "employee_id": 1,
    "date": "2025-10-01",
    "work_summary": "更新された作業内容",
    ...
  }
  ```
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**: `{"message": "日報を保存しました"}`

---

## 4. 社員マスターメンテナンス

### 4.1. マスターメンテナンスの認証

- **エンドポイント**: `POST /master/authenticate`
- **説明**: マスターメンテナンス画面を開くための認証を行います。
- **リクエストボディ**:
  ```json
  {
    "employee_id": 1,
    "password": "password123"
  }
  ```
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**:
    ```json
    {
      "success": true,
      "message": "認証に成功しました",
      "is_owner": true
    }
    ```
- **エラーレスポンス**:
  - `401 Unauthorized`: `{"success": false, "message": "認証情報が正しくありません"}`

### 4.2. 新しい社員を追加

- **エンドポイント**: `POST /api/employee`
- **説明**: 新しい社員情報を追加します。オーナーとして認証されている必要があります。
- **リクエストボディ**:
  ```json
  {
    "owner_id": 1,
    "owner_password": "owner_password",
    "company_id": 101,
    "employee_name": "新規社員",
    "department_name": "営業部",
    "employee_type": "契約社員",
    "retirement_flag": false
  }
  ```
- **成功レスポンス**:
  - **コード**: `201 Created`
  - **内容**: `{"message": "社員を追加しました", "employee_id": 124}`
- **エラーレスポンス**:
  - `403 Forbidden`: `{"error": "この操作を行う権限がありません"}`

### 4.3. 既存の社員情報を更新

- **エンドポイント**: `PUT /api/employee/<employee_id>`
- **説明**: 既存の社員情報を更新します。オーナーとして認証されており、かつ自身の会社の社員である必要があります。
- **URLパラメータ**:
  - `employee_id` (integer): 更新対象の社員ID。
- **リクエストボディ**:
  ```json
  {
    "owner_id": 1,
    "owner_password": "owner_password",
    "employee_name": "更新後の氏名",
    "department_name": "更新後の部署",
    ...
  }
  ```
- **成功レスポンス**:
  - **コード**: `200 OK`
  - **内容**: `{"message": "社員情報を更新しました"}`
- **エラーレスポンス**:
  - `403 Forbidden`: `{"error": "自分の会社の社員情報のみ更新できます"}`
